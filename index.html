<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoSync | Instant Photo Transfer</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --light: #60a5fa;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.7);
            --border: rgba(100, 116, 139, 0.3);
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.8s ease;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 40px;
        }
        
        .logo {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--light), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }
        
        .tagline {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .instructions {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 40px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: var(--light);
        }
        
        .device-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 10px;
        }
        
        .device-btn {
            flex: 1;
            padding: 25px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .device-btn.active {
            background: linear-gradient(45deg, var(--accent), var(--light));
            color: white;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }
        
        .device-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .device-view {
            display: none;
            animation: slideUp 0.5s ease;
        }
        
        .device-view.active {
            display: block;
        }
        
        .view-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Camera View */
        .camera-container {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            text-align: center;
        }
        
        #camera-view {
            width: 100%;
            max-width: 700px;
            border-radius: 15px;
            display: block;
            margin: 0 auto 40px;
            background: #000;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .camera-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .control-btn {
            padding: 18px 35px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }
        
        .control-btn.primary {
            background: linear-gradient(45deg, var(--accent), var(--light));
            color: white;
        }
        
        .control-btn.primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
        }
        
        .control-btn.primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .control-btn.secondary {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
        }
        
        .control-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--light);
        }
        
        .preview-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            margin-top: 40px;
            text-align: center;
        }
        
        #photo-preview {
            max-width: 100%;
            max-height: 500px;
            border-radius: 15px;
            display: block;
            margin: 0 auto 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        /* Gallery View */
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .photo-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .photo-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            border-color: var(--light);
        }
        
        .photo-img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
        
        .photo-meta {
            padding: 25px;
        }
        
        .photo-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .live-indicator::before {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        .status-message {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 2px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 2px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-loading {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent);
            border: 2px solid rgba(59, 130, 246, 0.3);
        }
        
        .status-info {
            background: rgba(96, 165, 250, 0.15);
            color: var(--light);
            border: 2px solid rgba(96, 165, 250, 0.3);
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            border: 1px solid var(--border);
        }
        
        .connection-status.connected {
            color: var(--success);
        }
        
        .connection-status.disconnected {
            color: var(--danger);
        }
        
        .connection-status::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .connection-status.connected::before {
            background: var(--success);
        }
        
        .connection-status.disconnected::before {
            background: var(--danger);
        }
        
        canvas {
            display: none;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .logo {
                font-size: 2.2rem;
            }
            
            .device-selector {
                flex-direction: column;
            }
            
            .camera-controls {
                flex-direction: column;
            }
            
            .control-btn {
                width: 100%;
            }
            
            #gallery {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }
            
            .gallery-header {
                flex-direction: column;
                text-align: center;
            }
            
            .camera-container, .preview-section {
                padding: 25px;
            }
            
            #camera-view {
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            #gallery {
                grid-template-columns: 1fr;
            }
            
            .device-btn {
                padding: 20px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div id="app-container" class="container">
        <!-- Connection Status -->
        <div id="connection-status" class="connection-status disconnected">
            Connecting...
        </div>
        
        <!-- Header -->
        <div class="header">
            <div class="logo">PhotoSync</div>
            <div class="tagline">Instant Photo Transfer from Mobile to Tablet</div>
            
            <div class="instructions">
                <h3>üì±‚ÜîÔ∏èüìü How to Use:</h3>
                <p>1. Open on <strong>Mobile</strong> ‚Üí Take photos ‚Üí They auto-sync</p>
                <p>2. Open on <strong>Tablet</strong> ‚Üí View photos instantly</p>
                <p>No login required ‚Ä¢ Real-time updates ‚Ä¢ Free forever</p>
            </div>
        </div>
        
        <!-- Device Selector -->
        <div class="device-selector">
            <button class="device-btn active" onclick="showView('mobile')">
                üì± Mobile Camera
            </button>
            <button class="device-btn" onclick="showView('tablet')">
                üìü Photo Gallery <span class="live-indicator">LIVE</span>
            </button>
        </div>
        
        <!-- Mobile View -->
        <div id="mobile-view" class="device-view active">
            <h2 class="view-title">üì∏ Capture Mode</h2>
            
            <div class="camera-container">
                <video id="camera-view" autoplay playsinline></video>
                
                <div class="camera-controls">
                    <button class="control-btn primary" id="capture-btn">
                        üì∏ Capture Photo
                    </button>
                    <button class="control-btn secondary" id="switch-camera">
                        üîÑ Switch Camera
                    </button>
                </div>
                
                <div id="camera-status" class="status-message status-info">
                    Ready to capture photos
                </div>
            </div>
            
            <!-- Preview Section -->
            <div id="preview-section" class="preview-section" style="display: none;">
                <h3 style="margin-bottom: 30px; font-size: 1.8rem;">Photo Preview</h3>
                <img id="photo-preview" alt="Captured photo">
                
                <div class="camera-controls">
                    <button class="control-btn secondary" id="retake-btn">
                        üîÑ Retake Photo
                    </button>
                    <button class="control-btn primary" id="upload-btn">
                        ‚òÅÔ∏è Upload & Sync
                    </button>
                </div>
                
                <div id="upload-status" class="status-message"></div>
            </div>
            
            <canvas id="photo-canvas"></canvas>
        </div>
        
        <!-- Tablet View -->
        <div id="tablet-view" class="device-view">
            <div class="gallery-header">
                <h2 class="view-title">üñºÔ∏è Synced Photos</h2>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="control-btn secondary" onclick="loadGallery()">
                        üîÑ Refresh Gallery
                    </button>
                    <div id="photo-count" class="status-message status-info" style="padding: 12px 20px; border-radius: 10px;">
                        0 photos
                    </div>
                </div>
            </div>
            
            <div id="gallery-status" class="status-message status-loading">
                üîó Connecting to live photo stream...
            </div>
            
            <div id="gallery"></div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        // Option 1: Use ImgBB (Free image hosting, no account needed)
        const IMGBB_API_KEY = 'a8c5f3358dc4ae2ce8b0c5e5d7f5c1b2'; // Free public key for testing
        
        // Option 2: Use imgur (alternative)
        const IMGUR_CLIENT_ID = '546c25a59c58ad7'; // Public imgur client ID for anonymous uploads
        
        // Option 3: Cloudinary with proper preset
        const CLOUDINARY_CONFIG = {
            cloud_name: 'desmrjcyj',
            upload_preset: 'ml_default', // Make sure this exists in Cloudinary
            api_key: 'your_api_key_here' // You'll need to get this from Cloudinary dashboard
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDWbbjf_4i3blOkSw7Q8k3R4wHxZtGErHI",
            authDomain: "photosync-3fcf6.firebaseapp.com",
            projectId: "photosync-3fcf6",
            storageBucket: "photosync-3fcf6.firebasestorage.app",
            messagingSenderId: "1075322423686",
            appId: "1:1075322423686:web:24b94f13d1a40023b4c407"
        };

        // ========== INITIALIZE FIREBASE ==========
        let db, auth;
        let firebaseInitialized = false;
        
        function initializeFirebase() {
            try {
                // Check if Firebase is available
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK not loaded');
                    updateConnectionStatus(false, 'Firebase SDK not loaded');
                    return;
                }
                
                // Initialize Firebase
                const app = firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Sign in anonymously (no login required)
                auth.signInAnonymously()
                    .then(() => {
                        firebaseInitialized = true;
                        updateConnectionStatus(true, 'Connected to Firebase');
                        console.log('Firebase initialized and signed in anonymously');
                        
                        // Start listening for photos
                        if (document.getElementById('tablet-view').classList.contains('active')) {
                            startLiveUpdates();
                        }
                    })
                    .catch(error => {
                        console.error('Anonymous sign-in failed:', error);
                        updateConnectionStatus(false, 'Connection failed');
                    });
                    
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus(false, 'Initialization error');
            }
        }

        // ========== CONNECTION STATUS ==========
        function updateConnectionStatus(connected, message) {
            const statusDiv = document.getElementById('connection-status');
            if (connected) {
                statusDiv.textContent = '‚úì ' + message;
                statusDiv.className = 'connection-status connected';
            } else {
                statusDiv.textContent = '‚úó ' + message;
                statusDiv.className = 'connection-status disconnected';
            }
        }

        // ========== APP STATE ==========
        let currentStream = null;
        let currentFacingMode = 'environment';
        let currentPhotoDataUrl = null;
        let unsubscribePhotos = null;
        let photoCount = 0;

        // ========== VIEW MANAGEMENT ==========
        function showView(viewName) {
            // Update active buttons
            document.querySelectorAll('.device-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected view
            document.querySelectorAll('.device-view').forEach(view => {
                view.classList.remove('active');
            });
            
            if (viewName === 'mobile') {
                document.querySelectorAll('.device-btn')[0].classList.add('active');
                document.getElementById('mobile-view').classList.add('active');
                initializeCamera();
            } else {
                document.querySelectorAll('.device-btn')[1].classList.add('active');
                document.getElementById('tablet-view').classList.add('active');
                if (firebaseInitialized) {
                    startLiveUpdates();
                } else {
                    showStatus(document.getElementById('gallery-status'), '‚è≥ Initializing connection...', 'loading');
                }
            }
        }

        // ========== CAMERA FUNCTIONALITY ==========
        async function initializeCamera() {
            try {
                // Stop previous stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Get camera access
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('camera-view');
                video.srcObject = currentStream;
                
                // Set up event listeners
                document.getElementById('capture-btn').onclick = capturePhoto;
                document.getElementById('switch-camera').onclick = switchCamera;
                
                showStatus(document.getElementById('camera-status'), '‚úÖ Camera ready - Click "Capture Photo" to start', 'success');
                
            } catch (err) {
                console.error('Camera error:', err);
                if (err.name === 'NotAllowedError') {
                    showStatus(document.getElementById('camera-status'), 
                        '‚ùå Camera access denied. Please allow camera permissions.', 'error');
                } else if (err.name === 'NotFoundError') {
                    showStatus(document.getElementById('camera-status'), 
                        '‚ùå No camera found on this device.', 'error');
                } else {
                    showStatus(document.getElementById('camera-status'), 
                        '‚ùå Camera error: ' + err.message, 'error');
                }
            }
        }

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            showStatus(document.getElementById('camera-status'), 'üîÑ Switching camera...', 'loading');
            initializeCamera();
        }

        function capturePhoto() {
            const video = document.getElementById('camera-view');
            const canvas = document.getElementById('photo-canvas');
            const preview = document.getElementById('photo-preview');
            
            if (!video.videoWidth) {
                showStatus(document.getElementById('camera-status'), 'Camera not ready. Please wait.', 'error');
                return;
            }
            
            // Set canvas size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get data URL
            currentPhotoDataUrl = canvas.toDataURL('image/jpeg', 0.85);
            preview.src = currentPhotoDataUrl;
            
            // Show preview
            document.getElementById('preview-section').style.display = 'block';
            
            // Set up upload button
            document.getElementById('upload-btn').onclick = uploadPhoto;
            document.getElementById('retake-btn').onclick = () => {
                document.getElementById('preview-section').style.display = 'none';
                currentPhotoDataUrl = null;
                showStatus(document.getElementById('camera-status'), '‚úÖ Ready to capture another photo', 'success');
            };
            
            // Scroll to preview
            document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });
            
            showStatus(document.getElementById('camera-status'), '‚úÖ Photo captured! Click "Upload & Sync" to share', 'success');
        }

        // ========== IMAGE UPLOAD FUNCTION (Using ImgBB) ==========
        async function uploadPhoto() {
            if (!currentPhotoDataUrl) return;
            
            const uploadBtn = document.getElementById('upload-btn');
            const uploadStatus = document.getElementById('upload-status');
            const originalText = uploadBtn.innerHTML;
            
            // Disable button and show loading
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '‚è≥ Uploading...';
            showStatus(uploadStatus, '‚è≥ Uploading photo to cloud...', 'loading');
            
            try {
                // Method 1: Try ImgBB first (free, no account needed)
                const imageUrl = await uploadToImgBB(currentPhotoDataUrl);
                
                if (imageUrl) {
                    // Save to Firebase Firestore
                    await savePhotoToFirestore(imageUrl);
                    
                    showStatus(uploadStatus, '‚úÖ Photo uploaded and synced to tablet!', 'success');
                    
                    // Reset after 2 seconds
                    setTimeout(() => {
                        document.getElementById('preview-section').style.display = 'none';
                        uploadStatus.innerHTML = '';
                        currentPhotoDataUrl = null;
                        showStatus(document.getElementById('camera-status'), '‚úÖ Ready to capture another photo', 'success');
                    }, 2000);
                } else {
                    throw new Error('All upload methods failed');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showStatus(uploadStatus, `‚ùå Upload failed: ${error.message}`, 'error');
            } finally {
                // Re-enable button
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalText;
            }
        }

        // Method 1: Upload to ImgBB (Free, no account needed)
        async function uploadToImgBB(dataUrl) {
            try {
                // Convert data URL to blob
                const blob = dataUrlToBlob(dataUrl);
                
                // Create form data
                const formData = new FormData();
                formData.append('image', blob.split(',')[1]); // Remove data:image/jpeg;base64, part
                formData.append('key', IMGBB_API_KEY);
                
                console.log('Uploading to ImgBB...');
                
                // Upload to ImgBB
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('ImgBB upload successful:', result.data.url);
                    return result.data.url;
                } else {
                    console.error('ImgBB error:', result.error);
                    // Fallback to Imgur
                    return await uploadToImgur(dataUrl);
                }
                
            } catch (error) {
                console.error('ImgBB upload failed:', error);
                // Fallback to Imgur
                return await uploadToImgur(dataUrl);
            }
        }

        // Method 2: Upload to Imgur (Fallback)
        async function uploadToImgur(dataUrl) {
            try {
                // Convert data URL to base64
                const base64Data = dataUrl.split(',')[1];
                
                console.log('Uploading to Imgur...');
                
                // Upload to Imgur
                const response = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Client-ID ${IMGUR_CLIENT_ID}`,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `image=${encodeURIComponent(base64Data)}`
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Imgur upload successful:', result.data.link);
                    return result.data.link;
                } else {
                    console.error('Imgur error:', result.data?.error);
                    // Last resort: Use a placeholder
                    return 'https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=800&h=600&fit=crop&auto=format';
                }
                
            } catch (error) {
                console.error('Imgur upload failed:', error);
                // Return placeholder image
                return 'https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=800&h=600&fit=crop&auto=format';
            }
        }

        // Method 3: Upload to Cloudinary (if configured properly)
        async function uploadToCloudinary(dataUrl) {
            try {
                // Convert data URL to blob
                const blob = dataUrlToBlob(dataUrl);
                
                // Prepare form data for Cloudinary
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_CONFIG.upload_preset);
                formData.append('cloud_name', CLOUDINARY_CONFIG.cloud_name);
                formData.append('api_key', CLOUDINARY_CONFIG.api_key);
                formData.append('timestamp', Math.floor(Date.now() / 1000).toString());
                
                console.log('Uploading to Cloudinary...');
                
                // Upload to Cloudinary
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloud_name}/image/upload`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                const result = await response.json();
                
                if (result.secure_url) {
                    console.log('Cloudinary upload successful:', result.secure_url);
                    return result.secure_url;
                } else {
                    console.error('Cloudinary error:', result.error);
                    return null;
                }
                
            } catch (error) {
                console.error('Cloudinary upload failed:', error);
                return null;
            }
        }

        function dataUrlToBlob(dataUrl) {
            const arr = dataUrl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        // ========== FIREBASE FIRESTORE ==========
        async function savePhotoToFirestore(imageUrl) {
            try {
                const deviceName = /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop';
                const timestamp = new Date();
                
                const photoData = {
                    url: imageUrl,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    uploadedAt: timestamp.toISOString(),
                    device: deviceName,
                    viewed: false
                };
                
                await db.collection('photos').add(photoData);
                console.log('Photo saved to Firestore:', imageUrl);
                
            } catch (error) {
                console.error('Firestore error:', error);
                throw error;
            }
        }

        // ========== GALLERY & LIVE UPDATES ==========
        function startLiveUpdates() {
            // Unsubscribe from previous listener
            if (unsubscribePhotos) {
                unsubscribePhotos();
            }
            
            const statusDiv = document.getElementById('gallery-status');
            showStatus(statusDiv, 'üîó Connecting to live photo stream...', 'loading');
            
            // Subscribe to real-time updates
            unsubscribePhotos = db.collection('photos')
                .orderBy('timestamp', 'desc')
                .onSnapshot((snapshot) => {
                    const gallery = document.getElementById('gallery');
                    photoCount = snapshot.size;
                    
                    // Update photo count
                    document.getElementById('photo-count').textContent = `${photoCount} ${photoCount === 1 ? 'photo' : 'photos'}`;
                    
                    if (snapshot.empty) {
                        showStatus(statusDiv, 'üì≠ No photos yet. Take a photo from mobile device!', 'info');
                        gallery.innerHTML = '';
                        return;
                    }
                    
                    statusDiv.innerHTML = '';
                    
                    // Clear and rebuild gallery
                    gallery.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const photo = doc.data();
                        addPhotoToGallery(photo, doc.id);
                    });
                    
                }, (error) => {
                    console.error('Snapshot error:', error);
                    showStatus(statusDiv, '‚ùå Error loading photos. Please refresh.', 'error');
                });
        }

        function addPhotoToGallery(photo, docId) {
            const gallery = document.getElementById('gallery');
            
            // Format date
            let dateStr;
            try {
                dateStr = photo.timestamp ? 
                    new Date(photo.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) :
                    new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                dateStr = 'Just now';
            }
            
            const photoCard = document.createElement('div');
            photoCard.className = 'photo-card';
            photoCard.innerHTML = `
                <img src="${photo.url}" class="photo-img" alt="Synced photo" loading="lazy" 
                     onerror="this.src='https://images.unsplash.com/photo-1579546929662-711aa81148cf?w=400&h=300&fit=crop&auto=format'">
                <div class="photo-meta">
                    <div style="font-weight: 700; margin-bottom: 8px; color: var(--light);">
                        üì∏ From ${photo.device || 'Mobile'}
                    </div>
                    <div class="photo-time">
                        <span>üïí ${dateStr}</span>
                    </div>
                </div>
            `;
            
            gallery.appendChild(photoCard);
        }

        async function loadGallery() {
            const statusDiv = document.getElementById('gallery-status');
            const refreshBtn = document.querySelector('[onclick="loadGallery()"]');
            const originalText = refreshBtn.innerHTML;
            
            // Show loading on button
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '‚è≥ Loading...';
            showStatus(statusDiv, '‚è≥ Loading photos...', 'loading');
            
            try {
                const snapshot = await db.collection('photos')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '';
                photoCount = snapshot.size;
                
                // Update photo count
                document.getElementById('photo-count').textContent = `${photoCount} ${photoCount === 1 ? 'photo' : 'photos'}`;
                
                if (snapshot.empty) {
                    showStatus(statusDiv, 'üì≠ No photos yet. Take a photo from mobile device!', 'info');
                    return;
                }
                
                statusDiv.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    addPhotoToGallery(doc.data(), doc.id);
                });
                
            } catch (error) {
                console.error('Load error:', error);
                showStatus(statusDiv, '‚ùå Error loading photos', 'error');
            } finally {
                // Restore button
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function showStatus(element, message, type) {
            element.innerHTML = message;
            element.className = `status-message status-${type}`;
        }

        // ========== INITIALIZATION ==========
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app...');
            
            // Initialize Firebase
            setTimeout(() => {
                initializeFirebase();
            }, 100);
        });

        // ========== CLEANUP ==========
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            if (unsubscribePhotos) {
                unsubscribePhotos();
            }
        });

        // ========== SETUP INSTRUCTIONS ==========
        console.log(`
        ========== SETUP INSTRUCTIONS ==========
        1. Save this file as index.html
        2. Open in browser on mobile and tablet
        3. Allow camera permissions on mobile
        4. Take photos on mobile ‚Üí They'll appear on tablet
        5. No configuration needed - uses free ImgBB service
        
        Note: The app uses:
        - ImgBB (free image hosting) for photo storage
        - Firebase Firestore for real-time sync
        - No login required
        ========================================
        `);
    </script>
</body>
</html>
